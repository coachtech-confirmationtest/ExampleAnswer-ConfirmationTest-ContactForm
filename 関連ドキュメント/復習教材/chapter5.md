# Chapter 5: ダミーデータの挿入 - シーディングでテスト環境を整える

## 🎯 このセクションで学ぶこと

このチャプターでは、アプリケーションのテストを効率化するための「**シーダー(Seeder)**」を作成します。手動でデータを一件ずつ登録する代わりに、コマンド一つでリアルなテストデータをデータベースに自動で投入（seed = 種をまく）する方法を学びます。これにより、いつでもクリーンでリアルなテスト環境を瞬時に再現でき、開発とテストのサイクルを大幅に高速化できます。

## 1. はじめに 📖

### シーダーとは？テストを効率化する「ダミーデータ生成工場」

アプリケーション開発におけるシーダー（Seeder）の役割は、「ダミーデータの自動生成工場」です。新しい機能を開発したり、既存の機能を修正したりするたびに、動作確認のために手動でフォームに名前やメールアドレスを入力するのは非常に手間がかかります。特に、ページネーションや検索機能のように、ある程度のデータ量がなければテスト自体が難しい機能もあります。

シーダーは、このような課題を解決します。あらかじめ「どのようなデータを」「何件生成するか」をプログラムとして定義しておくことで、コマンド一つでデータベースに大量のテストデータを投入できます。これにより、開発者はいつでもクリーンでリアルなテスト環境を瞬時に再現でき、開発とテストのサイクルを大幅に高速化できるのです。

また、シーダーは単なるランダムな文字列を生成するだけではありません。Laravelに組み込まれている**Faker**というライブラリを使えば、「本物らしい名前」や「実在する形式のメールアドレス」、「特定の範囲の日付」など、非常にリアルなデータを生成できます。リアルなデータでテストを行うことは、予期せぬレイアウト崩れやバリデーションエラーを発見する上で非常に重要です。

## 2. 要件の確認 📋

このチャプターで行う「シーディング」の具体的な要件を整理します。

| 項目 | 内容 |
| :--- | :--- |
| **`UserSeeder`** | ログイン認証に使用するテストユーザーを1件作成する。<br>例: `name`='Test User', `email`='test@example.com', `password`='password' |
| **`CategorySeeder`** | お問い合わせの種類を登録する。<br>例: 「商品のお届けについて」「商品の交換について」「商品トラブル」「ショップへのお問い合わせ」「その他」 |
| **`ContactSeeder`** | 1. `Category`をランダムに選択する。<br>2. Fakerを使い、リアルな個人情報（姓名、性別、メールアドレス、電話番号、住所など）を生成する。<br>3. 上記のデータを使って、`Contact`モデルのインスタンスを複数（例: 20件）作成し、データベースに保存する。 |
| **`DatabaseSeeder`** | `UserSeeder`, `CategorySeeder`, `ContactSeeder`を正しい順序で呼び出す。 |

## 3. 先輩エンジニアの思考プロセス 💭

経験豊富なエンジニアは、なぜシーダーを使うのでしょうか。その思考プロセスを覗いてみましょう。

### Point 1: テストは「作る」ことと同じくらい重要である

多くの初学者は、機能を作り終えた時点で「完成した」と感じてしまいます。しかし、プロの開発現場では、自分が書いたコードをテストし、品質を保証するところまでが「仕事」です。テストが不十分なままリリースされた機能は、バグを引き起こし、ユーザーの信頼を損ない、結果的に手戻りとなって何倍もの修正コストがかかります。シーダーを使ってテストデータを準備する作業は、面倒に思えるかもしれませんが、将来の自分を助けるための非常に重要な投資なのです。

### Point 2: シーダーは「使い捨て」かつ「何度でも実行可能」に設計する

シーダーの大きな利点は、データベースをまっさらな状態にした後、コマンド一つで何度でも同じテスト環境を再現できることです。これを実現するため、シーダーは「冪等性（べきとうせい）」、つまり「何度実行しても結果が同じになる」ように設計するのが理想です。例えば、`CategorySeeder`を実行するたびに同じカテゴリーがどんどん追加されてしまうのは良くありません。`Category::truncate()`のように、実行前に既存のデータをすべて削除する処理を入れることで、常にクリーンな状態からデータを作成できます。これにより、テストの前提条件が常に一定に保たれ、信頼性の高いテストが可能になります。

### Point 3: 「Faker」を使いこなし、リアルなデータを追求する

テストデータの質は、テストの質に直結します。`'name' => 'test'`のような単純なデータでは、予期せぬ文字数によるレイアウト崩れや、特定の文字種（例: 漢字、カタカナ）での不具合を見逃す可能性があります。Fakerライブラリは、`$faker->name`のような単純なものから、`$faker->realText(100)`（リアルな日本語の文章を100文字生成）や`$faker->numerify('##########')`（10桁の数字を生成）といった、より現実に即したデータを生成する機能が豊富に用意されています。`Faker::create('ja_JP')`のようにロケールを日本に設定すれば、日本の実情に合った名前や住所を生成してくれるため、テストの精度が格段に向上します。

## 4. 実装 🚀

テストデータを生成するためのシーダーを作成し、実行します。

### 4.1. `UserSeeder`の作成と編集

```bash
sail artisan make:seeder UserSeeder
```

作成された`database/seeders/UserSeeder.php`を以下のように編集します。

```php
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Hash;
use App\Models\User;

class UserSeeder extends Seeder
{
    public function run(): void
    {
        User::create([
            'name' => 'Test User',
            'email' => 'test@example.com',
            'password' => Hash::make('password'),
        ]);
    }
}
```

### 4.2. `CategorySeeder`の作成と編集

```bash
sail artisan make:seeder CategorySeeder
```

作成された`database/seeders/CategorySeeder.php`を以下のように編集します。

```php
<?php

namespace Database\Seeders;

use App\Models\Category;
use Illuminate\Database\Seeder;

class CategorySeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        Category::create(['content' => '商品のお届けについて']);
        Category::create(['content' => '商品の交換について']);
        Category::create(['content' => '商品トラブル']);
        Category::create(['content' => 'ショップへのお問い合わせ']);
        Category::create(['content' => 'その他']);
    }
}
```

### 4.3. `ContactSeeder`の作成と編集

```bash
sail artisan make:seeder ContactSeeder
```

作成された`database/seeders/ContactSeeder.php`を以下のように編集します。

```php
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use App\Models\Contact;
use App\Models\Category;
use Faker\Factory as Faker;

class ContactSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        $faker = Faker::create('ja_JP');
        $categories = Category::all();

        // サンプルデータを20件作成
        for ($i = 0; $i < 20; $i++) {
            Contact::create([
                'first_name' => $faker->firstName,
                'last_name' => $faker->lastName,
                'gender' => $faker->numberBetween(1, 3),
                'email' => $faker->unique()->safeEmail,
                'tel' => $faker->numerify('###########'),
                'address' => $faker->prefecture . $faker->city . $faker->streetAddress,
                'building' => $faker->optional()->secondaryAddress,
                'category_id' => $categories->random()->id,
                'detail' => $faker->realText(120),
            ]);
        }
    }
}
```

### 4.4. `DatabaseSeeder`の編集

`database/seeders/DatabaseSeeder.php`を開き、`run`メソッドのコメントアウトを解除し、作成したシーダーを呼び出すように編集します。

```php
<?php

namespace Database\Seeders;

// use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    /**
     * Seed the application's database.
     */
    public function run(): void
    {
        $this->call([
            UserSeeder::class,
            CategorySeeder::class,
            ContactSeeder::class,
        ]);
    }
}
```

### 4.5. マイグレーションとシーディングの実行

最後に、以下のコマンドを実行して、データベースのテーブルを一度すべて削除してから再作成し、その後、定義したシーダーを実行してテストデータを投入します。

```bash
# マイグレーションをリフレッシュし、シーダーを実行する
sail artisan migrate:fresh --seed
```

これで、データベースに20件のリアルなテストデータが準備されました。

## 5. コードの詳細解説 🔍

### `database/seeders/UserSeeder.php` の解説
- **`User::create([...])`**: `User`モデルを使って、テスト用のユーザーを1件作成します。
- **`'password' => Hash::make('password')`**: パスワードは、`Hash::make`を使って必ずハッシュ化してからデータベースに保存します。平文のまま保存してはいけません。

### `database/seeders/CategorySeeder.php` の解説
- **`Category::create([...])`**: `Category`モデルを使って、お問い合わせの選択肢となるカテゴリーを複数作成します。ここでは5つのカテゴリーを固定で作成しています。

### `database/seeders/ContactSeeder.php` の解説
- **`use Faker\Factory as Faker;`**: Fakerライブラリを使用するための`use`文です。
- **`$faker = Faker::create('ja_JP');`**: Fakerのインスタンスを生成します。引数に`'ja_JP'`を渡すことで、日本のロケールに基づいたデータ（日本の名前、住所など）を生成するようになります。
- **`$categories = Category::all();`**: `categories`テーブルからすべてのレコードを取得し、コレクションとして`$categories`に格納します。
- **`for ($i = 0; $i < 20; $i++) { ... }`**: 20回ループを回し、20件のダミーデータを作成します。
- **`Contact::create([...])`**: `Contact`モデルの`create`メソッドを使い、新しいレコードをデータベースに作成します。引数には、カラム名をキー、生成する値をバリューとする連想配列を渡します。
- **`'first_name' => $faker->firstName`**: Fakerを使って、本物らしい「名」を生成します。
- **`'gender' => $faker->numberBetween(1, 3)`**: 1から3までのランダムな整数を生成します。
- **`'email' => $faker->unique()->safeEmail`**: `unique()`を付けることで、このシーダー実行中に重複しないメールアドレスを保証します。`safeEmail`は、`example.com`のような安全なドメインのメールアドレスを生成します。
- **`'tel' => $faker->numerify('###########')`**: `#`をランダムな数字（0-9）に置き換えます。ここでは11桁の数字文字列を生成しています。
- **`'address' => $faker->prefecture . $faker->city . $faker->streetAddress`**: 都道府県、市、それ以降の住所を連結して、リアルな住所を作成しています。
- **`'building' => $faker->optional()->secondaryAddress`**: `optional()`を付けると、一定の確率で`null`を返すようになります。建物名は必ず存在するとは限らないため、より現実的なデータを生成できます。
- **`'category_id' => $categories->random()->id`**: 先ほど取得したカテゴリーのコレクションから、`random()`メソッドでランダムに1つの`Category`モデルを取得し、その`id`プロパティを参照しています。
- **`'detail' => $faker->realText(120)`**: 実際のラテン語の単語を組み合わせて、自然な見た目の日本語のテキストを約120文字生成します。

### `database/seeders/DatabaseSeeder.php` の解説
- **`$this->call([...])`**: `run`メソッド内で`$this->call()`メソッドを使うことで、他のシーダークラスを呼び出すことができます。配列で渡したシーダーが、上から順番に実行されます。依存関係がある場合は、呼び出し順序が重要です（例: `ContactSeeder`は`CategorySeeder`の後に実行する必要がある）。

## 6. How to: この実装にたどり着くための調べ方 🗺️

ここでは、あなたが一人で「テストデータを作りたい」と思った時に、AIアシスタントを壁打ち相手として活用しながら、段階的に学習を進める方法を紹介します。

### Step 1: 公式ドキュメントを読みやすくまとめる

まずは、これから学ぶ「シーディング」という技術の全体像を掴むために、AIに公式ドキュメントの要約を依頼します。

> **プロンプト例**
> 以下はLaravelの公式ドキュメントの一部です。 これを「実装できるように」分かりやすくまとめてください。
>
> 出力してほしい内容：
> - 重要ポイント（10行以内）
> - 用語の説明（重要なものだけ）
> - できること / できないこと（境界をはっきり）
> - よくある落とし穴（回避策つき）
> - 最小で動かすための手順（コードはまだ不要）
>
> --- ここから ---
> （ここに、Laravel公式ドキュメントの「Database: Seeding」のページ内容を貼り付ける）
> --- ここまで ---

**🤖 このプロンプトのポイント**
- **目的の明確化**: 「実装できるように」と目的を伝えることで、AIは単なる要約ではなく、実践的な情報にフォーカスしてくれます。
- **出力形式の指定**: 箇条書きで出力形式を細かく指定することで、自分が欲しい情報を構造的に、抜け漏れなく得ることができます。
- **情報源の限定**: Web上の不確かな情報ではなく、信頼できる「公式ドキュメント」を情報源として指定することで、正確な知識の土台を築きます。

### Step 2: 「なぜそうなる？」をはっきりさせる（理解を固める）

全体像を掴んだら、次はSeederと関連技術（FactoryやFaker）の違いや関係性について、自分の理解が正しいかを確認します。

> **プロンプト例**
> LaravelのSeeder、Factory、Fakerについて、私の理解はこうです：
> 「SeederはDBにデータを投入する司令官。Factoryはモデル（例: Contact）の設計図で、Seederから『Contactを10個作って』と指示されると、設計図通りにオブジェクトを作る。Fakerはリアルな部品（名前や住所）を供給する業者で、Factoryが部品を要求する。」
>
> お願い：
> 1) この理解は正しいですか？間違いがあれば「たとえ話の誤り」を指摘してください。
> 2) 3つの関係性を「入力→中で起きること→出力」で説明してください。
> 3) Seederだけで完結する場合と、Factoryを併用する場合の使い分けを教えてください。
> 4) よくある勘違いを3つ教えてください。
> 5) 理解チェック問題を3問ください（答えつき）。

**🤖 このプロンプトのポイント**
- **自分の言葉で説明する**: 自分の現在の理解を先に示すことで、AIはどこが分かっていてどこが分かっていないのかを正確に把握し、的確なフィードバックを返せます。
- **多角的な質問**: 「たとえ話」「仕組み」「使い分け」「勘違い」など、様々な角度から質問することで、一つの概念を立体的に理解できます。
- **アウトプットを求める**: 「理解チェック問題」を出してもらうことで、知識が本当に定着したかを確認できます。

### Step 3: 実装に落とす（指定フォーマット：手順→解説→例→解説）

概念を理解したら、いよいよ実装です。AIに「先生役」を依頼し、構造化されたフォーマットで実装方法を教えてもらいます。

> **プロンプト例**
> 目的は、お問い合わせフォームのテストデータ（20件）をSeederで作ることです。
> 前提知識は、Laravelのモデルとマイグレーションは理解しています。
>
> 次の順番で出力してください：
>
> A. 実装の手順・方針
> - まず全体の方針（なぜそのやり方か。今回はFactoryを使わない理由も）
> - 手順を1〜Nで（各手順に「できたらOK」の条件も書く）
>
> B. 関連技術の解説
> - 必要な関連知識を3〜5個（例: Fakerの日本語化、optional()の使い方など）
> - 各項目は「一言で説明 → この実装で何に使う → 注意点」
>
> C. 実装例
> - まず最小で動く`ContactSeeder`の例
> - 次に実務向けの拡張例（`unique()`や`optional()`を使ったリアルなデータ）
>
> D. コードの解説
> - 重要な部分だけ「何をしてるか」「なぜそう書くか」
> - よくあるバグと対策

**🤖 このプロンプトのポイント**
- **前提条件の提示**: 自分のスキルレベル（どこまで知っているか）を伝えることで、AIは不要な説明を省略し、あなたに最適なレベルの説明を提供します。
- **構造化された出力形式**: 「A. 方針 → B. 解説 → C. 実装例 → D. コード解説」という流れを指定することで、思考の流れに沿った、非常に理解しやすいドキュメントが得られます。
- **段階的な実装例**: 「最小構成」と「実務向け」の2段階でコードを提示してもらうことで、基本から応用へとスムーズに理解を進めることができます。

### Step 4: 設計レビュー（指摘をもらう）

自分で書いたコードや、これから書こうとしている設計案について、AIにレビューを依頼します。今回は「冪等性」という重要な概念について相談してみましょう。

> **プロンプト例**
> 以下の`CategorySeeder`の設計をレビューしてください。
>
> - 目的：お問い合わせカテゴリーの初期データを投入する
> - 制約：`migrate:fresh --seed`で毎回実行される
> - 設計案：
> ```php
> public function run(): void
> {
>     Category::create(['content' => '商品のお届けについて']);
>     Category::create(['content' => '商品の交換について']);
>     // ...以下続く
> }
> ```
> - 不安な点：このままだと、`db:seed`コマンドを単体で実行した時にデータが重複してしまうのではないか？
>
> 見てほしい観点：
> - 冪等性（何度実行しても同じ結果になるか）
> - 保守性（将来カテゴリーが増減した時に対応しやすいか）
>
> 出力：
> - 指摘を「重要度：高/中/低」で出す
> - 各指摘に「理由」「影響」「直し方」をつける
> - 最後に「この設計が失敗しやすい例」を3つ出す

**🤖 このプロンプトのポイント**
- **具体的なコードと不安な点を伝える**: 何に困っているのかを具体的に示すことで、AIは的確なアドバイスをくれます。
- **レビュー観点を指定する**: 「冪等性」「保守性」など、特に見てほしいポイントを伝えることで、より質の高いレビューが得られます。
- **改善策まで求める**: 「指摘」だけでなく「理由」「影響」「直し方」までセットで要求することで、次に何をすべきかが明確になります。

## 7. まとめ ✨

このチャプターでは、SeederとFakerを使って、リアルなテストデータをコマンド一つで自動生成する方法を学びました。これにより、効率的で信頼性の高いテスト環境を構築しました。Factoryを使わずにSeeder内で直接データを生成する方法は、処理がシンプルでわかりやすいというメリットがあります。

- **Seederの活用**: テストデータを自動生成し、開発効率を向上させました。
- **Fakerの活用**: ロケールを設定し、リアルなダミーデータを生成しました。
- **データベースの初期化**: `migrate:fresh --seed`コマンドで、データベースの初期化とテストデータの投入を自動化しました。

次のチャプターでは、作成したAPIエンドポイントに対して、実際にリクエストを送信するための「道」となる、**ルーティング**について学んでいきます。
